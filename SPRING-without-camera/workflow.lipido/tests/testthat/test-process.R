testthat::test_that("workflow polarity", {
    # initialize parameters
    raw_files <- c(
        system.file(
            "testdata",
            "220221CCM_global_POS_01_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        system.file(
            "testdata",
            "220221CCM_global_POS_02_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        file.path(
            system.file(
                "testdata",
                package = "workflow.lipido"
            ),
            "220221CCM_global_POS_03_ssleu_filtered.mzML"
        ),
        system.file(
            "testdata",
            "220221CCM_global_NEG_01_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        system.file(
            "testdata",
            "220221CCM_global_NEG_02_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        file.path(
            system.file(
                "testdata",
                package = "workflow.lipido"
            ),
            "220221CCM_global_NEG_03_ssleu_filtered.mzML"
        )
    )
    sqlite_path <- tempfile(fileext = ".sqlite")
    converter <- tools::file_path_as_absolute(
        "~/GitHub/workflow.lipido/pwiz/msconvert.exe"
    )
    cwt_params <- xcms::CentWaveParam(
        ppm = 30,
        peakwidth = c(4, 39),
        snthresh = 1,
        prefilter = c(2, 815),
        mzCenterFun = "wMean",
        integrate = 1,
        mzdiff = .041,
        fitgauss = FALSE,
        noise = 0,
        verboseColumns = TRUE,
        firstBaselineCheck = FALSE
    )
    obw_params <- xcms::ObiwarpParam(
        binSize = .1,
        centerSample = integer(),
        response = 1L,
        distFun = "cor_opt",
        gapInit = .3,
        gapExtend = 2.4,
        factorDiag = 2,
        factorGap = 1,
        localAlignment = FALSE,
        initPenalty = 0
    )
    pd_params <- xcms::PeakDensityParam(
        sampleGroups = seq(3),
        bw = 5,
        minFraction = 10**-9,
        minSamples = 1,
        binSize = 0.01,
        maxFeatures = 500
    )
    ann_params <- AnnotationParam(
        da_tol = .015,
        rt_tol = 10,
        abd_tol = 25,
        adduct_names = c(
            "[M+Na]+",
            "[M+NH4]+",
            "[M+H-H2O]+",
            "[M+H]+",
            "[M-H]-"
        ),
        database = "test",
        instrument = "QTOF_XevoG2-S_R25000@200",
        cpd_classes = c("LPC", "Cer", "FA")
    )
    filter_params <- FilterParam(cwt_params, ann_params)

    # record files
    db <- db_connect(sqlite_path)
    sample_names <- unique(gsub(
        "(positive)|(negative)|(pos)|(neg)",
        "",
        tools::file_path_sans_ext(basename(raw_files)),
        ignore.case = TRUE
    ))
    db_record_samples(db, sample_names)
    a <- do.call(rbind, lapply(raw_files, function(raw_file) {
        sample_name <- gsub(
            "(positive)|(negative)|(pos)|(neg)", "",
            tools::file_path_sans_ext(basename(raw_file)),
            ignore.case = TRUE
        )
        cbind(
            sample = sample_name,
            positive = import_ms_file(
                db,
                sample_name,
                raw_file,
                converter,
                "positive",
                filter_params
            ),
            negative = import_ms_file(
                db,
                sample_name,
                raw_file,
                converter,
                "negative",
                filter_params
            )
        )
    }
    ))
    RSQLite::dbDisconnect(db)

    # 1st test: positive
    xset <- ms_process_polarity(
        sqlite_path,
        sample_names,
        "positive",
        cwt_params,
        obw_params,
        pd_params,
        ann_params
    )
    testthat::expect_equal(
        xset@ann,
        data.frame(
            group_id = c(1, 1, 2, 2, 9, 9, 10, 11),
            class = c(rep("LPC", 6), rep("Cer", 2)),
            name = c("LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0",
                     "LPC 11:0", "LPC 11a:0", "Cer (d18:1/C12:0)",
                     "Cer (d18:1/C12:0)"),
            formula = c("C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                        "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                        "C30H59N1O3", "C30H59N1O3"),
            adduct = c("[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+",
                       "[M+Na]+", "[M+Na]+", "[M+H-H2O]+", "[M+Na]+"),
            ion_formula = c("C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                            "C19H41N1O7P1", "C19H40N1O7P1Na1",
                            "C19H40N1O7P1Na1", "C30H58N1O2", "C30H59N1O3Na1"),
            rtdiff = c(9.52199999999993, 4.72199999999998, 8.99149999999997,
                       4.19150000000002, 8.99299999999994, 4.19299999999998,
                       5.97300000000001, 5.70850000000002),
            rt = c(286.278, 286.278, 286.8085, 286.8085, 286.807, 286.807,
                   201.573, 201.3085),
            rtmin = c(284.692, 284.692, 284.692, 284.692, 282.048, 282.048,
                      196.386, 178.178),
            rtmax = c(287.864, 287.864, 292.098, 292.098, 292.095, 292.095,
                      206.729, 215.038),
            nsamples = c(1, 1, 2, 2, 1, 1, 2, 2),
            best_score = c(79.8211975097656, 79.8211975097656, 95.1391906738281,
                           95.1391906738281, 79.6432037353516, 79.6432037353516,
                           71.3979721069336, 89.4345550537109),
            best_deviation_mz = c(0.0003662109375, 0.0003662109375,
                                  0.0008544921875, 0.0008544921875,
                                  0.000701904296875, 0.000701904296875,
                                  0.0010986328125, 0.00140380859375),
            best_npeak = c(1, 1, 2, 2, 1, 1, 1, 2),
            `220221CCM_global__01_ssleu_filtered` = c(NA, NA, 2, 2, NA, NA,
                                                         5, 7),
            `220221CCM_global__02_ssleu_filtered` = c(1, 1, 3, 3, 4, 4, 6,
                                                         8),
            `220221CCM_global__03_ssleu_filtered` = c(NA, NA, NA, NA, NA, NA,
                                                         NA, NA),
            check.names = FALSE
        )
    )
    testthat::expect_equal(
        xset@spectra_infos,
        data.frame(
            spectra_id = c(1, 2, 3, 4, 5, 6, 7, 8),
            score = c(79.8211975097656, 94.9317855834961, 95.1391906738281,
                      79.6432037353516, 71.3979721069336, 71.3979721069336,
                      89.4345550537109, 88.4888916015625),
            deviation_mz = c(0.0003662109375, 0.000457763671875,
                             0.0008544921875, 0.000701904296875,
                             0.0010986328125, 0.001251220703125,
                             0.00140380859375, 0.0017852783203125),
            npeak = c(1, 2, 2, 1, 1, 1, 2, 2),
            basepeak_int = c(88824.635233072, 6214416.44108707,
                             6201250.27168528, 288290.748778874,
                             4945601.93026269, 5689144.27927454,
                             1448292.29379181, 1662831.19267642),
            sum_int = c(88824.635233072, 7385056.39979801, 7388017.8361341,
                        288290.748778874, 4945601.93026269, 5689144.27927454,
                        1849363.52087931, 2106914.27998355),
            sample = c("220221CCM_global__02_ssleu_filtered",
                       "220221CCM_global__01_ssleu_filtered",
                       "220221CCM_global__02_ssleu_filtered",
                       "220221CCM_global__02_ssleu_filtered",
                       "220221CCM_global__01_ssleu_filtered",
                       "220221CCM_global__02_ssleu_filtered",
                       "220221CCM_global__01_ssleu_filtered",
                       "220221CCM_global__02_ssleu_filtered"),
            rt = c(286.278, 286.81, 286.807, 286.807, 197.973, 205.173, 197.444,
                   205.173)
        )
    )
    testthat::expect_equal(
        xset@spectras,
        data.frame(
            spectra_id = c(1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5,
                           5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8),
            feature_id = c(17, NA, NA, NA, 5, 4, NA, NA, 20, 19, NA, NA, 18, NA,
                           NA, NA, 1, NA, NA, NA, 14, NA, NA, NA, 2, 3, NA, NA,
                           15, 13, NA, NA),
            mz = c(408.251325886321, NA, NA, NA, 426.261913381751,
                   427.265348519813, NA, NA, 426.262333104945, 427.265704881008,
                   NA, NA, 448.244170162955, NA, NA, NA, 464.447304014051, NA,
                   NA, NA, 464.447454557257, NA, NA, NA, 504.440032161331,
                   505.443534603, NA, NA, 504.44048100644, 505.44383474773, NA,
                   NA),
            int = c(88824.635233072, NA, NA, NA, 6214416.44108707,
                    1170639.95871094, NA, NA, 6201250.27168528,
                    1186767.56444882, NA, NA, 288290.748778874, NA, NA, NA,
                    4945601.93026269, NA, NA, NA, 5689144.27927454, NA, NA, NA,
                    1448292.29379181, 401071.227087501, NA, NA,
                    1662831.19267642, 444083.087307128, NA, NA),
            abd = c(100, NA, NA, NA, 100, 18.8374881182917, NA, NA, 100,
                    19.1375531135642, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA,
                    100, NA, NA, NA, 100, 27.6926991054717, NA, NA, 100,
                    26.7064443620612, NA, NA),
            ion_id_theo = c(5, 5, 5, 5, 7, 7, 7, 7, 7, 7, 7, 7, 6, 6, 6, 6, 9,
                            9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10,
                            10),
            mz_theo = c(408.25095, 409.25427, 410.25672, 411.25935, 426.26152,
                        427.26484, 428.26719, 429.26984, 426.26152, 427.26484,
                        428.26719, 429.26984, 448.24346, 449.24678, 450.24914,
                        451.25178, 464.44621, 465.44955, 466.45272, 467.45576,
                        464.44621, 465.44955, 466.45272, 467.45576, 504.43872,
                        505.44206, 506.44516, 507.44809, 504.43872, 505.44206,
                        506.44516, 507.44809),
            abd_theo = c(100, 21.65, 3.25, 0.38, 100, 21.7, 3.46, 0.42, 100,
                        21.7, 3.46, 0.42, 100, 21.69, 3.45, 0.42, 100, 33.55,
                        5.86, 0.65, 100, 33.55, 5.86, 0.65, 100, 33.67, 6.07,
                        0.72, 100, 33.67, 6.07, 0.72),
            iso_theo = c("M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3",
                         "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3",
                         "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3",
                         "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3")
        )
    )
    testthat::expect_equal(
        xset@groups,
        matrix(
            c(408.251325886321, 426.262123243348, 427.265526700411,
              428.267904280982, 428.268229167555, 429.27060132947,
              429.270256788594, 429.270493526998, 448.244170162955,
              464.447379285654, 504.440256583886, 505.443684675365,
              408.251325886321, 426.261913381751, 427.265348519813,
              428.267835743959, 428.267896400125, 429.270341280206,
              429.270175958258, 429.270493526998, 448.244170162955,
              464.447304014051, 504.440032161331, 505.443534603,
              408.251325886321, 426.262333104945, 427.265704881008,
              428.268466489791, 428.268561934985, 429.270861378734,
              429.270782294993, 429.270493526998, 448.244170162955,
              464.447454557257, 504.44048100644, 505.44383474773, 286.278,
              286.8085, 286.8085, 279.407, 259.3105, 259.8395, 301.616, 279.407,
              286.807, 201.573, 201.3085, 201.044, 286.278, 286.807, 286.807,
              278.875, 258.253, 258.253, 291.569, 279.407, 286.807, 197.973,
              197.444, 197.444, 286.278, 286.81, 286.81, 291.569, 260.368,
              261.426, 306.914, 279.407, 286.807, 205.173, 205.173, 204.644, 1,
              2, 2, 3, 2, 2, 3, 1, 1, 2, 2, 2, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1,
              1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
              0, 0, 0),
            nrow = 12, ncol = 10, dimnames = list(
                c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                       "npeaks", "1", "2", "3")
            )
        )
    )
    testthat::expect_equal(
        xset@peaks,
        matrix(
            c(464.447304014051, 504.440032161331, 505.443534603,
              427.265348519813, 426.261913381751, 428.267835743959,
              428.267896400125, 428.267904280982, 429.270493526998,
              429.270341280206, 429.270256788594, 429.270175958258,
              505.44383474773, 464.447454557257, 504.44048100644,
              429.270861378734, 408.251325886321, 448.244170162955,
              427.265704881008, 426.262333104945, 428.268466489791,
              428.268561934985, 429.270782294993, 464.447021484375,
              504.439697265625, 505.443084716797, 427.264587402344,
              426.261444091797, 428.267547607422, 428.267425537109,
              428.267456054688, 429.270263671875, 429.269653320312,
              429.269836425781, 429.269622802734, 505.440704345703,
              464.446746826172, 504.439544677734, 429.270660400391,
              408.251037597656, 448.242279052734, 427.265258789062,
              426.262023925781, 428.268035888672, 428.267822265625,
              429.270416259766, 464.447662353516, 504.440490722656,
              505.443664550781, 427.266052246094, 426.262420654297,
              428.268310546875, 428.268615722656, 428.268249511719,
              429.270660400391, 429.270904541016, 429.270751953125,
              429.270874023438, 505.444122314453, 464.447967529297,
              504.441101074219, 429.271148681641, 408.25146484375,
              448.245422363281, 427.266052246094, 426.262786865234,
              428.269195556641, 428.269287109375, 429.271636962891, 197.973,
              197.444, 197.444, 286.81, 286.81, 279.407, 260.368, 291.569,
              279.407, 258.253, 291.569, 301.616, 204.644, 205.173, 205.173,
              261.426, 286.278, 286.807, 286.807, 286.807, 278.875, 258.253,
              306.914, 196.386, 194.271, 196.386, 284.695, 284.695, 275.706,
              232.343, 287.339, 275.706, 232.343, 287.339, 298.443, 203.577,
              203.038, 178.178, 258.253, 284.692, 282.048, 283.105, 284.692,
              266.184, 232.343, 301.084, 200.617, 199.03, 199.03, 291.04,
              292.098, 287.339, 261.426, 295.799, 286.81, 265.656, 296.328,
              305.847, 207.757, 206.729, 215.038, 264.069, 287.864, 292.095,
              292.095, 292.095, 292.095, 265.656, 309.559, 4945601.93026269,
              1448292.29379181, 401071.227087501, 1170639.95871094,
              6214416.44108707, 10859267.7547045, 15396334.0742375,
              3559573.81687499, 2574017.18247619, 4567668.49476563,
              847985.874378674, 392347.130863636, 444083.087307128,
              5689144.27927454, 1662831.19267642, 801559.236409095,
              88824.635233072, 288290.748778874, 1186767.56444882,
              6201250.27168528, 20076653.1797449, 18139587.026625,
              323001.699462891, 4945464.15722767, 1448264.72345856,
              401069.111887501, 1170634.14246094, 6212404.90921921,
              10279271.7340996, 14009363.2233988, 3181331.80055223,
              2490170.67943366, 4327555.39189945, 790817.501274091,
              248786.599772727, 444001.578713656, 5689141.10698883,
              1662613.35060178, 801553.420409095, 88821.9918997387,
              287904.836179229, 1185632.54587715, 6201242.86868528,
              18364665.4121469, 15982556.4399262, 209052.408698731, 4130684,
              1395886, 434808.75, 676902.5, 3501824, 1096165, 592012.5, 533287,
              266683.75, 168154.5, 123908.25, 84350.125, 524308, 5734716,
              1723138, 150635.375, 70041.5625, 186253.875, 673140, 3489368,
              1078367, 657937, 68280.5, 8329, 22672, 434808, 676902, 3587, 10,
              7, 4, 12, 7, 5, 1, 4386, 5734715, 14423, 145000, 70041, 675, 1134,
              3489367, 9, 5, 1, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 1,
              2, 3, 4, 6, 7, 7, 7, 8, 8, 8, 11, 1, 2, 3, 4, 5, 6, 7, 8, 9, 9,
              14, 1, 2, 1, 2, 1, 2, 1, 0, 1, 1, 1, 2, 7, 2, 3, 1, 1, 2, 1, 1, 0,
              1, 3, 3, 3, 3, 5, 5, 3, 15, 5, 3, 13, 5, 3, 3, 13, 19, 3, 3, 5, 5,
              5, 11, 13, 5, 58, 57, 57, 187, 187, 173, 137, 196, 173, 133, 196,
              215, 57, 58, 58, 136, 183, 184, 184, 184, 169, 130, 222, 55, 54,
              54, 182, 182, 170, 122, 191, 170, 120, 191, 212, 54, 45, 39, 133,
              180, 179, 179, 179, 158, 117, 217, 61, 60, 60, 192, 192, 176, 152,
              201, 176, 146, 201, 218, 60, 71, 77, 139, 186, 189, 189, 189, 180,
              143, 227, 55, 52, 55, 87, 87, 134, 87, 156, 134, 87, 156, 85, 55,
              54, 20, 101, 87, 82, 84, 87, 116, 87, 79, 63, 60, 60, 99, 101,
              156, 107, 172, 155, 115, 173, 96, 63, 61, 77, 112, 93, 101, 101,
              101, 165, 115, 95, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2,
              2, 2, 2, 2, 2, 2, 2),
            nrow = 23, ncol = 23, dimnames = list(
                c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                       "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                       "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                       "lmax", "sample")
            )
        )
    )

    # 2nd test: negative
    xset <- ms_process_polarity(
        sqlite_path,
        sample_names,
        "negative",
        cwt_params,
        obw_params,
        pd_params,
        ann_params
    )
    testthat::expect_equal(
        xset@ann,
        data.frame(
            group_id = 1,
            class = "FA",
            name = "FA 17:0",
            formula = "C17H34O2",
            adduct = "[M-H]-",
            ion_formula = "C17H33O2",
            rtdiff = 2.18899999999999,
            rt = 178.411,
            rtmin = 175.0360,
            rtmax = 181.586,
            nsamples = 2,
            best_score = 99.5300903320312,
            best_deviation_mz = -0.000111897788883653,
            best_npeak = 3,
            `220221CCM_global__01_ssleu_filtered` = 1,
            `220221CCM_global__02_ssleu_filtered` = 2,
            `220221CCM_global__03_ssleu_filtered` = NA,
            check.names = FALSE
        )
    )
    testthat::expect_equal(
        xset@spectra_infos,
        data.frame(
            spectra_id = c(1, 2),
            score = c(82.740364074707, 99.5300903320312),
            deviation_mz = c(-0.001068115234375, -0.000111897788883653),
            npeak = c(1, 3),
            basepeak_int = c(8927664.85468527, 4593482.66518999),
            sum_int = c(8927664.85468527, 5580653.54818653),
            sample = c("220221CCM_global__01_ssleu_filtered",
                       "220221CCM_global__02_ssleu_filtered"),
            rt = c(178.504, 178.318)
        )
    )
    testthat::expect_equal(
        xset@spectras,
        data.frame(
            spectra_id = c(1, 1, 1, 2, 2, 2),
            feature_id = c(2, NA, NA, 8, 7, 6),
            mz = c(269.247528218739, NA, NA, 269.248411023224, 270.251620537443,
                   271.255056943515),
            int = c(8927664.85468527, NA, NA, 4593482.66518999,
                    899482.748384234, 87688.1346123047),
            abd = c(100, NA, NA, 100, 19.5817164000777, 1.90896844515855),
            ion_id_theo = c(1, 1, 1, 1, 1, 1),
            mz_theo = c(269.2486, 270.25202, 271.25481, 269.2486, 270.25202,
                        271.25481),
            abd_theo = c(100, 18.84, 2.02, 100, 18.84, 2.02),
            iso_theo = c("M", "M+1", "M+2", "M", "M+1", "M+2")
        )
    )
    testthat::expect_equal(
        xset@groups,
        matrix(
            c(269.247969620981, 269.248194873815, 269.248075605062,
              270.251251784179, 270.251620537443, 271.255056943515,
              269.247528218739, 269.248194873815, 269.248075605062,
              270.25119624422, 270.251620537443, 271.255056943515,
              269.248411023224, 269.248194873815, 269.248075605062,
              270.251307324138, 270.251620537443, 271.255056943515, 178.411,
              207.703, 146.11, 146.797, 178.318, 178.318, 178.318, 207.703,
              146.11, 146.538, 178.318, 178.318, 178.504, 207.703, 146.11,
              147.056, 178.318, 178.318, 2, 1, 1, 2, 1, 1, 1, 1, 0, 1, 0, 0, 1,
              0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0),
            nrow = 6, ncol = 10, dimnames = list(
                c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                       "npeaks", "1", "2", "3")
            )
        )
    )
    testthat::expect_equal(
        xset@peaks,
        matrix(
            c(270.25119624422, 269.247528218739, 269.248194873815,
              270.251307324138, 269.248075605062, 271.255056943515,
              270.251620537443, 269.248411023224, 270.250793457031,
              269.247406005859, 269.24755859375, 270.250823974609,
              269.247589111328, 271.254425048828, 270.251403808594,
              269.247833251953, 270.251953125, 269.247985839844,
              269.249572753906, 270.25244140625, 269.248596191406,
              271.256134033203, 270.251831054688, 269.248565673828, 147.056,
              178.504, 207.703, 146.538, 146.11, 178.318, 178.318, 178.318,
              144.809, 175.697, 203.298, 144.81, 144.81, 175.036, 175.036,
              175.036, 149.306, 180.384, 212.035, 150.968, 150.968, 179.727,
              181.586, 181.586, 15852.5738923645, 8927664.85468527,
              18758.2195488281, 18160.7346019531, 136136.373335937,
              87688.1346123047, 899482.748384234, 4593482.66518999,
              13737.5420380623, 8654644.93987011, 12054.5931199951,
              15262.9337143676, 118521.494192171, 75981.4533509554,
              886826.38870081, 4540712.99687556, 8709.96875, 6265286.5,
              2761.9111328125, 8407.2734375, 71703.6875, 53069.5625, 734161,
              3772552, 13, 15, 3, 11, 11, 3, 109, 298, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 1, 2, 3, 1, 2, 6, 7, 8, 3,
              2, 4, 6, 3, 6, 2, 1, 2, 2, 2, 3, 3, 3, 3, 3, 5, 44, 75, 5, 4, 52,
              52, 52, 3, 42, 73, 2, 1, 49, 49, 49, 7, 46, 77, 8, 7, 55, 55, 55,
              1, 40, 66, 1, 1, 47, 47, 47, 9, 48, 74, 11, 11, 55, 58, 58, 1, 1,
              1, 2, 2, 2, 2, 2),
            nrow = 8, ncol = 23, dimnames = list(
                c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                       "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                       "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                       "lmax", "sample")
            )
        )
    )
})

testthat::test_that("merge xsets", {
    sample_names <- c("220221CCM_global__01_ssleu_filtered",
                      "220221CCM_global__02_ssleu_filtered",
                      "220221CCM_global__03_ssleu_filtered")
    empty_peaklist <- matrix(, nrow = 0, ncol = 23, dimnames = list(
        c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
               "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
               "dppm", "scale", "scpos", "scmin", "scmax", "lmin", "lmax",
               "sample")
    ))
    empty_groups <- matrix(, nrow = 0, ncol = 7 + length(sample_names),
                          dimnames = list(c(), c("mzmed", "mzmin", "mzmax",
                             "rtmed", "rtmin", "rtmax",
                             "npeaks",
                             seq(length(sample_names)))
                             )
                          )
    empty_ann <- data.frame(
        matrix(, nrow = 0, ncol = 14 + length(sample_names), dimnames = list(
            c(), c("group_id", "class", "name", "formula", "adduct",
                   "ion_formula", "rtdiff", "rt", "rtmin", "rtmax", "nsamples",
                   "best_score", "best_deviation_mz", "best_npeak",
                   sample_names))
        ),
        check.names = FALSE
    )
    empty_spectra_infos <- data.frame(
        matrix(, nrow = 0, ncol = 8, dimnames = list(
            c(), c("spectra_id", "score", "deviation_mz", "npeak",
                   "basepeak_int", "sum_int", "sample", "rt")
        )))
    empty_spectras <- data.frame(
        matrix(, nrow = 0, ncol = 9, dimnames = list(
            c(), c("spectra_id", "feature_id", "mz", "int", "abd",
                   "ion_id_theo", "mz_theo", "abd_theo", "iso_theo")
        )))
    peaks_pos <- matrix(
        c(464.447304014051, 504.440032161331, 505.443534603,
          427.265348519813, 426.261913381751, 428.267835743959,
          428.267896400125, 428.267904280982, 429.270493526998,
          429.270341280206, 429.270256788594, 429.270175958258,
          505.44383474773, 464.447454557257, 504.44048100644,
          429.270861378734, 408.251325886321, 448.244170162955,
          427.265704881008, 426.262333104945, 428.268466489791,
          428.268561934985, 429.270782294993, 464.447021484375,
          504.439697265625, 505.443084716797, 427.264587402344,
          426.261444091797, 428.267547607422, 428.267425537109,
          428.267456054688, 429.270263671875, 429.269653320312,
          429.269836425781, 429.269622802734, 505.440704345703,
          464.446746826172, 504.439544677734, 429.270660400391,
          408.251037597656, 448.242279052734, 427.265258789062,
          426.262023925781, 428.268035888672, 428.267822265625,
          429.270416259766, 464.447662353516, 504.440490722656,
          505.443664550781, 427.266052246094, 426.262420654297,
          428.268310546875, 428.268615722656, 428.268249511719,
          429.270660400391, 429.270904541016, 429.270751953125,
          429.270874023438, 505.444122314453, 464.447967529297,
          504.441101074219, 429.271148681641, 408.25146484375,
          448.245422363281, 427.266052246094, 426.262786865234,
          428.269195556641, 428.269287109375, 429.271636962891, 197.973,
          197.444, 197.444, 286.81, 286.81, 279.407, 260.368, 291.569, 279.407,
          258.253, 291.569, 301.616, 204.644, 205.173, 205.173, 261.426,
          286.278, 286.807, 286.807, 286.807, 278.875, 258.253, 306.914,
          196.386, 194.271, 196.386, 284.695, 284.695, 275.706, 232.343,
          287.339, 275.706, 232.343, 287.339, 298.443, 203.577, 203.038,
          178.178, 258.253, 284.692, 282.048, 283.105, 284.692, 266.184,
          232.343, 301.084, 200.617, 199.03, 199.03, 291.04, 292.098, 287.339,
          261.426, 295.799, 286.81, 265.656, 296.328, 305.847, 207.757, 206.729,
          215.038, 264.069, 287.864, 292.095, 292.095, 292.095, 292.095,
          265.656, 309.559, 4945601.93026269, 1448292.29379181,
          401071.227087501, 1170639.95871094, 6214416.44108707,
          10859267.7547045, 15396334.0742375, 3559573.81687499,
          2574017.18247619, 4567668.49476563, 847985.874378674,
          392347.130863636, 444083.087307128, 5689144.27927454,
          1662831.19267642, 801559.236409095, 88824.635233072, 288290.748778874,
          1186767.56444882, 6201250.27168528, 20076653.1797449, 18139587.026625,
          323001.699462891, 4945464.15722767, 1448264.72345856,
          401069.111887501, 1170634.14246094, 6212404.90921921,
          10279271.7340996, 14009363.2233988, 3181331.80055223,
          2490170.67943366, 4327555.39189945, 790817.501274091,
          248786.599772727, 444001.578713656, 5689141.10698883,
          1662613.35060178, 801553.420409095, 88821.9918997387,
          287904.836179229, 1185632.54587715, 6201242.86868528,
          18364665.4121469, 15982556.4399262, 209052.408698731, 4130684,
          1395886, 434808.75, 676902.5, 3501824, 1096165, 592012.5, 533287,
          266683.75, 168154.5, 123908.25, 84350.125, 524308, 5734716, 1723138,
          150635.375, 70041.5625, 186253.875, 673140, 3489368, 1078367, 657937,
          68280.5, 8329, 22672, 434808, 676902, 3587, 10, 7, 4, 12, 7, 5, 1,
          4386, 5734715, 14423, 145000, 70041, 675, 1134, 3489367, 9, 5, 1, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, 1, 2, 3, 4, 6, 7, 7, 7, 8, 8, 8, 11, 1, 2, 3,
          4, 5, 6, 7, 8, 9, 9, 14, 1, 2, 1, 2, 1, 2, 1, 0, 1, 1, 1, 2, 7, 2, 3,
          1, 1, 2, 1, 1, 0, 1, 3, 3, 3, 3, 5, 5, 3, 15, 5, 3, 13, 5, 3, 3, 13,
          19, 3, 3, 5, 5, 5, 11, 13, 5, 58, 57, 57, 187, 187, 173, 137, 196,
          173, 133, 196, 215, 57, 58, 58, 136, 183, 184, 184, 184, 169, 130,
          222, 55, 54, 54, 182, 182, 170, 122, 191, 170, 120, 191, 212, 54, 45,
          39, 133, 180, 179, 179, 179, 158, 117, 217, 61, 60, 60, 192, 192, 176,
          152, 201, 176, 146, 201, 218, 60, 71, 77, 139, 186, 189, 189, 189,
          180, 143, 227, 55, 52, 55, 87, 87, 134, 87, 156, 134, 87, 156, 85, 55,
          54, 20, 101, 87, 82, 84, 87, 116, 87, 79, 63, 60, 60, 99, 101, 156,
          107, 172, 155, 115, 173, 96, 63, 61, 77, 112, 93, 101, 101, 101, 165,
          115, 95, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2,
          2, 2, 2),
        nrow = 23, ncol = 23, dimnames = list(
            c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                   "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                   "dppm", "scale", "scpos", "scmin", "scmax", "lmin", "lmax",
                   "sample")
        )
    )
    peaks_pos_df <- cbind.data.frame(
        feature_id = seq(nrow(peaks_pos)),
        peaks_pos[, c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                  "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                  "dppm", "scale", "scpos", "scmin", "scmax", "lmin", "lmax")],
        sample = sample_names[peaks_pos[, "sample"]],
        polarity = "positive"
    )
    colnames(peaks_pos_df)[which(colnames(peaks_pos_df) == "into")] <- "int"
    groupidx_pos <- list(
        17,
        c(5, 20),
        c(4, 19),
        c(6, 8, 21),
        c(7, 22),
        c(10, 16),
        c(11, 12, 23),
        9,
        18,
        c(1, 14),
        c(2, 15),
        c(3, 13)
    )
    groups_pos <- matrix(
        c(408.251325886321, 426.262123243348, 427.265526700411,
          428.267904280982, 428.268229167555, 429.27060132947, 429.270256788594,
          429.270493526998, 448.244170162955, 464.447379285654,
          504.440256583886, 505.443684675365, 408.251325886321,
          426.261913381751, 427.265348519813, 428.267835743959,
          428.267896400125, 429.270341280206, 429.270175958258,
          429.270493526998, 448.244170162955, 464.447304014051,
          504.440032161331, 505.443534603, 408.251325886321, 426.262333104945,
          427.265704881008, 428.268466489791, 428.268561934985,
          429.270861378734, 429.270782294993, 429.270493526998,
          448.244170162955, 464.447454557257, 504.44048100644, 505.44383474773,
          286.278, 286.8085, 286.8085, 279.407, 259.3105, 259.8395, 301.616,
          279.407, 286.807, 201.573, 201.3085, 201.044, 286.278, 286.807,
          286.807, 278.875, 258.253, 258.253, 291.569, 279.407, 286.807,
          197.973, 197.444, 197.444, 286.278, 286.81, 286.81, 291.569, 260.368,
          261.426, 306.914, 279.407, 286.807, 205.173, 205.173, 204.644, 1, 2,
          2, 3, 2, 2, 3, 1, 1, 2, 2, 2, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1,
          1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
        nrow = 12, ncol = 10, dimnames = list(
            c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                   "npeaks", "1", "2", "3")
        )
    )
    groups_pos_df <- cbind.data.frame(
        group_id = seq(nrow(groups_pos)),
        polarity = "positive",
        groups_pos[, c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                       "npeaks")],
        `220221CCM_global__01_ssleu_filtered` = c(NA, 5, 4, 6, 7, 10, 12,
                                                  9, NA, 1, 2, 3),
        `220221CCM_global__02_ssleu_filtered` = c(17, 20, 19, 21, 22, 16,
                                                  23, NA, 18, 14, 15, 13),
        `220221CCM_global__03_ssleu_filtered` = as.numeric(c(NA, NA, NA,
                                                             NA, NA, NA,
                                                             NA, NA, NA,
                                                             NA, NA, NA))
    )
    spectra_pos <- data.frame(
        spectra_id = c(1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5,
                       5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8),
        feature_id = c(NA, 17, NA, NA, 5, 4, NA, NA, 20, 19, NA, NA, 18, NA,
                       NA, NA, 1, NA, NA, NA, 14, NA, NA, NA, 2, 3, NA, NA,
                       15, 13, NA, NA),
        mz = c(NA, 408.251325886321, NA, NA, 426.261913381751,
               427.265348519813, NA, NA, 426.262333104945, 427.265704881008,
               NA, NA, 448.244170162955, NA, NA, NA, 464.447304014051, NA,
               NA, NA, 464.447454557257, NA, NA, NA, 504.440032161331,
               505.443534603, NA, NA, 504.44048100644, 505.44383474773, NA,
               NA),
        int = c(NA, 88824.635233072, NA, NA, 6214416.44108707,
                1170639.95871094, NA, NA, 6201250.27168528,
                1186767.56444882, NA, NA, 288290.748778874, NA, NA, NA,
                4945601.93026269, NA, NA, NA, 5689144.27927454, NA, NA, NA,
                1448292.29379181, 401071.227087501, NA, NA,
                1662831.19267642, 444083.087307128, NA, NA),
        abd = c(NA, 100, NA, NA, 100, 18.8374881182917, NA, NA, 100,
                19.1375531135642, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA,
                100, NA, NA, NA, 100, 27.6926991054717, NA, NA, 100,
                26.7064443620612, NA, NA),
        ion_id_theo = c(62, 62, 62, 62, 66, 66, 66, 66, 66, 66, 66, 66, 64,
                        64, 64, 64, 278, 278, 278, 278, 278, 278, 278, 278,
                        281, 281, 281, 281, 281, 281, 281, 281),
        mz_theo = c(411.25935, 408.25095, 409.25427, 410.25672, 426.26152,
                    427.26484, 428.26719, 429.26984, 426.26152, 427.26484,
                    428.26719, 429.26984, 448.24346, 449.24678, 450.24914,
                    451.25178, 464.44621, 465.44955, 466.45272, 467.45576,
                    464.44621, 465.44955, 466.45272, 467.45576, 504.43872,
                    505.44206, 506.44516, 507.44809, 504.43872, 505.44206,
                    506.44516, 507.44809),
        abd_theo = c(0.38, 100, 21.65, 3.25, 100, 21.7, 3.46, 0.42, 100,
                     21.7, 3.46, 0.42, 100, 21.69, 3.45, 0.42, 100, 33.55,
                     5.86, 0.65, 100, 33.55, 5.86, 0.65, 100, 33.67, 6.07,
                     0.72, 100, 33.67, 6.07, 0.72),
        iso_theo = c("M+3", "M", "M+1", "M+2", "M", "M+1", "M+2", "M+3",
                     "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3",
                     "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3",
                     "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3")
    )
    spectra_infos_pos <- data.frame(
        spectra_id = c(1, 2, 3, 4, 5, 6, 7, 8),
        score = c(79.8211975097656, 94.9317855834961, 95.1391906738281,
                  79.6432037353516, 71.3979721069336, 71.3979721069336,
                  89.4345550537109, 88.4888916015625),
        deviation_mz = c(0.0003662109375, 0.000457763671875,
                         0.0008544921875, 0.000701904296875,
                         0.0010986328125, 0.001251220703125,
                         0.00140380859375, 0.0017852783203125),
        npeak = c(1, 2, 2, 1, 1, 1, 2, 2),
        basepeak_int = c(88824.635233072, 6214416.44108707,
                         6201250.27168528, 288290.748778874,
                         4945601.93026269, 5689144.27927454,
                         1448292.29379181, 1662831.19267642),
        sum_int = c(88824.635233072, 7385056.39979801, 7388017.8361341,
                    288290.748778874, 4945601.93026269, 5689144.27927454,
                    1849363.52087931, 2106914.27998355),
        sample = c("220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered"),
        rt = c(286.278, 286.81, 286.807, 286.807, 197.973, 205.173, 197.444,
               205.173)
    )
    ann_pos <- data.frame(
        group_id = c(1, 1, 2, 2, 9, 9, 10, 11),
        class = c(rep("LPC", 6), rep("Cer", 2)),
        name = c("LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0",
                 "LPC 11:0", "LPC 11a:0", "Cer (d18:1/C12:0)",
                 "Cer (d18:1/C12:0)"),
        formula = c("C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C30H59N1O3", "C30H59N1O3"),
        adduct = c("[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+",
                   "[M+Na]+", "[M+Na]+", "[M+H-H2O]+", "[M+Na]+"),
        ion_formula = c("C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                        "C19H41N1O7P1", "C19H40N1O7P1Na1",
                        "C19H40N1O7P1Na1", "C30H58N1O2", "C30H59N1O3Na1"),
        rtdiff = c(9.52199999999993, 4.72199999999998, 8.99149999999997,
                   4.19150000000002, 8.99299999999994, 4.19299999999998,
                   5.97300000000001, 5.70850000000002),
        rt = c(286.278, 286.278, 286.8085, 286.8085, 286.807, 286.807,
               201.573, 201.3085),
        rtmin = c(284.692, 284.692, 284.692, 284.692, 282.048, 282.048,
                  196.386, 178.178),
        rtmax = c(287.864, 287.864, 292.098, 292.098, 292.095, 292.095,
                  206.729, 215.038),
        nsamples = c(1, 1, 2, 2, 1, 1, 2, 2),
        best_score = c(79.8211975097656, 79.8211975097656, 95.1391906738281,
                       95.1391906738281, 79.6432037353516, 79.6432037353516,
                       71.3979721069336, 89.4345550537109),
        best_deviation_mz = c(0.0003662109375, 0.0003662109375,
                              0.0008544921875, 0.0008544921875,
                              0.000701904296875, 0.000701904296875,
                              0.0010986328125, 0.00140380859375),
        best_npeak = c(1, 1, 2, 2, 1, 1, 1, 2),
        `220221CCM_global__01_ssleu_filtered` = c(NA, NA, 2, 2, NA, NA,
                                                  5, 7),
        `220221CCM_global__02_ssleu_filtered` = c(1, 1, 3, 3, 4, 4, 6,
                                                  8),
        `220221CCM_global__03_ssleu_filtered` = c(NA, NA, NA, NA, NA, NA,
                                                  NA, NA),
        check.names = FALSE
    )
    peaks_neg <- matrix(
        c(270.25119624422, 269.247528218739, 269.248194873815,
          270.251307324138, 269.248075605062, 271.255056943515,
          270.251620537443, 269.248411023224, 270.250793457031,
          269.247406005859, 269.24755859375, 270.250823974609,
          269.247589111328, 271.254425048828, 270.251403808594,
          269.247833251953, 270.251953125, 269.247985839844,
          269.249572753906, 270.25244140625, 269.248596191406,
          271.256134033203, 270.251831054688, 269.248565673828, 147.056,
          178.504, 207.703, 146.538, 146.11, 178.318, 178.318, 178.318,
          144.809, 175.697, 203.298, 144.81, 144.81, 175.036, 175.036,
          175.036, 149.306, 180.384, 212.035, 150.968, 150.968, 179.727,
          181.586, 181.586, 15852.5738923645, 8927664.85468527,
          18758.2195488281, 18160.7346019531, 136136.373335937,
          87688.1346123047, 899482.748384234, 4593482.66518999,
          13737.5420380623, 8654644.93987011, 12054.5931199951,
          15262.9337143676, 118521.494192171, 75981.4533509554,
          886826.38870081, 4540712.99687556, 8709.96875, 6265286.5,
          2761.9111328125, 8407.2734375, 71703.6875, 53069.5625, 734161,
          3772552, 13, 15, 3, 11, 11, 3, 109, 298, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 1, 2, 3, 1, 2, 6, 7, 8, 3,
          2, 4, 6, 3, 6, 2, 1, 2, 2, 2, 3, 3, 3, 3, 3, 5, 44, 75, 5, 4, 52,
          52, 52, 3, 42, 73, 2, 1, 49, 49, 49, 7, 46, 77, 8, 7, 55, 55, 55,
          1, 40, 66, 1, 1, 47, 47, 47, 9, 48, 74, 11, 11, 55, 58, 58, 1, 1,
          1, 2, 2, 2, 2, 2),
        nrow = 8, ncol = 23, dimnames = list(
            c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                   "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                   "dppm", "scale", "scpos", "scmin", "scmax", "lmin", "lmax",
                   "sample")
        )
    )
    peaks_neg_df <- cbind.data.frame(
        feature_id = seq(nrow(peaks_neg)),
        peaks_neg[, c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                      "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                      "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                      "lmax")],
        sample = sample_names[peaks_neg[, "sample"]],
        polarity = "negative"
    )
    colnames(peaks_neg_df)[which(colnames(peaks_neg_df) == "into")] <- "int"
    groupidx_neg <- list(
        c(2, 8),
        3,
        5,
        c(1, 4),
        7,
        6
    )
    groups_neg <- matrix(
        c(269.247969620981, 269.248194873815, 269.248075605062,
          270.251251784179, 270.251620537443, 271.255056943515,
          269.247528218739, 269.248194873815, 269.248075605062,
          270.25119624422, 270.251620537443, 271.255056943515,
          269.248411023224, 269.248194873815, 269.248075605062,
          270.251307324138, 270.251620537443, 271.255056943515, 178.411,
          207.703, 146.11, 146.797, 178.318, 178.318, 178.318, 207.703,
          146.11, 146.538, 178.318, 178.318, 178.504, 207.703, 146.11,
          147.056, 178.318, 178.318, 2, 1, 1, 2, 1, 1, 1, 1, 0, 1, 0, 0, 1,
          0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0),
        nrow = 6, ncol = 10, dimnames = list(
            c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                   "npeaks", "1", "2", "3")
        )
    )
    groups_neg_df <- cbind.data.frame(
        group_id = seq(nrow(groups_neg)),
        polarity = "negative",
        groups_neg[, c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                       "npeaks")],
        `220221CCM_global__01_ssleu_filtered` = c(2, 3, NA, 1, NA, NA),
        `220221CCM_global__02_ssleu_filtered` = c(8, NA, 5, 4, 7, 6),
        `220221CCM_global__03_ssleu_filtered` = as.numeric(c(NA, NA, NA,
                                                             NA, NA, NA))
    )
    spectras_neg <- data.frame(
        spectra_id = c(1, 1, 1, 2, 2, 2),
        feature_id = c(2, NA, NA, 8, 7, 6),
        mz = c(269.247528218739, NA, NA, 269.248411023224, 270.251620537443,
               271.255056943515),
        int = c(8927664.85468527, NA, NA, 4593482.66518999,
                899482.748384234, 87688.1346123047),
        abd = c(100, NA, NA, 100, 19.5817164000777, 1.90896844515855),
        ion_id_theo = c(8, 8, 8, 8, 8, 8),
        mz_theo = c(269.2486, 270.25202, 271.25481, 269.2486, 270.25202,
                    271.25481),
        abd_theo = c(100, 18.84, 2.02, 100, 18.84, 2.02),
        iso_theo = c("M", "M+1", "M+2", "M", "M+1", "M+2")
    )
    spectra_infos_neg <- data.frame(
        spectra_id = c(1, 2),
        score = c(82.740364074707, 99.5300903320312),
        deviation_mz = c(-0.001068115234375, -0.000111897788883653),
        npeak = c(1, 3),
        basepeak_int = c(8927664.85468527, 4593482.66518999),
        sum_int = c(8927664.85468527, 5580653.54818653),
        sample = c("220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered"),
        rt = c(178.504, 178.318)
    )
    ann_neg <- data.frame(
        group_id = 1,
        class = "FA",
        name = "FA 17:0",
        formula = "C17H34O2",
        adduct = "[M-H]-",
        ion_formula = "C17H33O2",
        rtdiff = 2.18899999999999,
        rt = 178.411,
        rtmin = 175.3665,
        rtmax = 180.985,
        nsamples = 2,
        best_score = 99.5300903320312,
        best_deviation_mz = -0.000111897788883653,
        best_npeak = 3,
        `220221CCM_global__01_ssleu_filtered` = 1,
        `220221CCM_global__02_ssleu_filtered` = 2,
        `220221CCM_global__03_ssleu_filtered` = as.integer(NA),
        check.names = FALSE
    )
    groups <- rbind(groups_pos_df, groups_neg_df)
    groups$group_id <- seq(nrow(groups))
    groups[(nrow(groups_pos) + 1) : nrow(groups), 10:ncol(groups)] <-
        groups[(nrow(groups_pos) + 1) : nrow(groups), 10:ncol(groups)] +
        nrow(peaks_pos)
    peaks <- rbind(peaks_pos_df, peaks_neg_df)
    peaks[(nrow(peaks_pos) + 1) : nrow(peaks), "feature_id"] <-
        peaks[(nrow(peaks_pos) + 1) : nrow(peaks), "feature_id"] +
        nrow(peaks_pos)
    xset <- methods::new("xcmsSet")
    xset@phenoData <- data.frame(
        class = rep(runif(1), 3),
        row.names = sample_names
    )
    xset@peaks <- empty_peaklist
    xset@groups <- empty_groups
    xset@groupidx <- list()
    attributes(xset)$ann <- empty_ann
    attributes(xset)$spectra_infos <- empty_spectra_infos
    attributes(xset)$spectras <- empty_spectras
    xset_pos <- xset_neg <- xset

    # 1st test: with no peaks
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        empty_ann
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        empty_spectra_infos
    )
    testthat::expect_equal(
        merged_results$spectras,
        empty_spectras
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        data.frame(
            matrix(, nrow = 0, ncol = 9 + length(sample_names),
                              dimnames = list(
                c(), c("group_id", "polarity", "mzmed", "mzmin", "mzmax",
                       "rtmed", "rtmin", "rtmax", "npeaks", sample_names)
            )),
            check.names = FALSE
        )
    )
    testthat::expect_equal(
        merged_results$peaks,
        data.frame(matrix(, nrow = 0, ncol = 25, dimnames = list(
            c(), c("feature_id", "mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax",
                   "int", "intb", "maxo", "sn", "egauss", "mu", "sigma", "h",
                   "f", "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                   "lmax", "sample", "polarity")
        )))
    )

    # 2nd test: with only positive peaks & no annotations
    xset_pos@peaks <- peaks_pos
    xset_pos@groupidx <- groupidx_pos
    xset_pos@groups <- groups_pos
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        empty_ann
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        empty_spectra_infos
    )
    testthat::expect_equal(
        merged_results$spectras,
        empty_spectras
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups_pos_df
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks_pos_df
    )

    # 3rd test: with only negative peaks & no annotations
    xset_pos@peaks <- empty_peaklist
    xset_pos@groups <- empty_groups
    xset_pos@groupidx <- list()
    xset_neg@peaks <- peaks_neg
    xset_neg@groups <- groups_neg
    xset_neg@groupidx <- groupidx_neg
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        empty_ann
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        empty_spectra_infos
    )
    testthat::expect_equal(
        merged_results$spectras,
        empty_spectras
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups_neg_df
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks_neg_df
    )

    # 4th test: with positive & negative peaks & no annotations
    xset_pos@peaks <- peaks_pos
    xset_pos@groupidx <- groupidx_pos
    xset_pos@groups <- groups_pos
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        empty_ann
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        empty_spectra_infos
    )
    testthat::expect_equal(
        merged_results$spectras,
        empty_spectras
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks
    )

    # 5th test: with only positive annotations
    attributes(xset_pos)$ann <- ann_pos
    attributes(xset_pos)$spectra_infos <- spectra_infos_pos
    attributes(xset_pos)$spectras <- spectra_pos
    xset_neg@peaks <- empty_peaklist
    xset_neg@groups <- empty_groups
    xset_neg@groupidx <- list()
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        ann_pos
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        spectra_infos_pos
    )
    testthat::expect_equal(
        merged_results$spectras,
        spectra_pos
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups_pos_df
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks_pos_df
    )

    # 6th test: with only negative annotations
    xset_pos@peaks <- empty_peaklist
    xset_pos@groups <- empty_groups
    xset_pos@groupidx <- list()
    attributes(xset_pos)$ann <- empty_ann
    attributes(xset_pos)$spectra_infos <- empty_spectra_infos
    attributes(xset_pos)$spectras <- empty_spectras
    xset_neg@peaks <- peaks_neg
    xset_neg@groups <- groups_neg
    xset_neg@groupidx <- groupidx_neg
    attributes(xset_neg)$ann <- ann_neg
    attributes(xset_neg)$spectra_infos <- spectra_infos_neg
    attributes(xset_neg)$spectras <- spectras_neg
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        ann_neg
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        spectra_infos_neg
    )
    testthat::expect_equal(
        merged_results$spectras,
        spectras_neg
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups_neg_df
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks_neg_df
    )

    # 7th test: with negative peaks & positive annotations
    xset_pos@peaks <- peaks_pos
    xset_pos@groupidx <- groupidx_pos
    xset_pos@groups <- groups_pos
    attributes(xset_pos)$ann <- ann_pos
    attributes(xset_pos)$spectra_infos <- spectra_infos_pos
    attributes(xset_pos)$spectras <- spectra_pos
    attributes(xset_neg)$ann <- empty_ann
    attributes(xset_neg)$spectra_infos <- empty_spectra_infos
    attributes(xset_neg)$spectras <- empty_spectras
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        ann_pos
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        spectra_infos_pos
    )
    testthat::expect_equal(
        merged_results$spectras,
        spectra_pos
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks
    )

    # 8th test: with positive peaks & negative annotations
    attributes(xset_pos)$ann <- empty_ann
    attributes(xset_pos)$spectra_infos <- empty_spectra_infos
    attributes(xset_pos)$spectras <- empty_spectras
    attributes(xset_neg)$ann <- ann_neg
    attributes(xset_neg)$spectra_infos <- spectra_infos_neg
    attributes(xset_neg)$spectras <- spectras_neg
    # the IDs for groups & feature change because now we have peaks on neg/pos
    ann_neg$group_id <- ann_neg$group_id + nrow(groups_pos)
    spectras_neg$feature_id <- spectras_neg$feature_id + nrow(peaks_pos)
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        ann_neg
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        spectra_infos_neg
    )
    testthat::expect_equal(
        merged_results$spectras,
        spectras_neg
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks
    )

    # 9th test: with positive & negative annotations
    attributes(xset_pos)$ann <- ann_pos
    attributes(xset_pos)$spectra_infos <- spectra_infos_pos
    attributes(xset_pos)$spectras <- spectra_pos
    # dont forget to update the IDs
    ann_neg[, (ncol(ann_neg) - length(sample_names) + 1):ncol(ann_neg)] <-
        ann_neg[, (ncol(ann_neg) - length(sample_names) + 1):ncol(ann_neg)] +
            nrow(spectra_infos_pos)
    spectra_infos_neg$spectra_id <- spectra_infos_neg$spectra_id +
        nrow(spectra_infos_pos)
    spectras_neg$spectra_id <- spectras_neg$spectra_id + nrow(spectra_infos_pos)
    merged_results <- merge_xsets(xset_pos, xset_neg, nsamples = 3)
    testthat::expect_equal(
        merged_results$ann,
        rbind(ann_pos, ann_neg)
    )
    testthat::expect_equal(
        merged_results$spectra_infos,
        rbind(spectra_infos_pos, spectra_infos_neg)
    )
    testthat::expect_equal(
        merged_results$spectras,
        rbind(spectra_pos, spectras_neg)
    )
    testthat::expect_equal(
        merged_results$peak_groups,
        groups
    )
    testthat::expect_equal(
        merged_results$peaks,
        peaks
    )
})

testthat::test_that("workflow", {
    ann <- data.frame(
        group_id = c(1, 1, 2, 2, 9, 9, 10, 11, 13),
        class = c(rep("LPC", 6), rep("Cer", 2), "FA"),
        name = c("LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0", "LPC 11:0",
                 "LPC 11a:0", "Cer (d18:1/C12:0)", "Cer (d18:1/C12:0)",
                 "FA 17:0"),
        formula = c("C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C30H59N1O3", "C30H59N1O3", "C17H34O2"),
        adduct = c("[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+", "[M+Na]+",
                   "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", "[M-H]-"),
        ion_formula = c("C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                        "C19H41N1O7P1", "C19H40N1O7P1Na1", "C19H40N1O7P1Na1",
                        "C30H58N1O2", "C30H59N1O3Na1", "C17H33O2"),
        rtdiff = c(9.52199999999993, 4.72199999999998, 8.99149999999997,
                   4.19150000000002, 8.99299999999994, 4.19299999999998,
                   5.97300000000001, 5.70849999999999, 2.18899999999999),
        rt = c(286.278, 286.278, 286.8085, 286.8085, 286.807, 286.807, 201.573,
               201.3085, 178.411),
        rtmin = c(284.692, 284.692, 284.692, 284.692, 282.048, 282.048, 196.386,
                  178.178, 175.036),
        rtmax = c(287.864, 287.864, 292.098, 292.098, 292.095, 292.095, 206.729,
                  215.038, 181.586),
        nsamples = c(1, 1, 2, 2, 1, 1, 2, 2, 2),
        best_score = c(79.8211975097656, 79.8211975097656, 95.1391906738281,
                       95.1391906738281, 79.6432037353516, 79.6432037353516,
                       71.3979721069336, 89.4345550537109, 99.5300903320312),
        best_deviation_mz = c(0.0003662109375, 0.0003662109375, 0.0008544921875,
                              0.0008544921875, 0.000701904296875,
                              0.000701904296875, 0.0010986328125,
                              0.00140380859375, -0.000111897788883653),
        best_npeak = c(1, 1, 2, 2, 1, 1, 1, 2, 3),
        `220221CCM_global__01_ssleu_filtered` = c(NA, NA, 2, 2, NA, NA, 5, 7,
                                                  9),
        `220221CCM_global__02_ssleu_filtered` = c(1, 1, 3, 3, 4, 4, 6, 8, 10),
        check.names = FALSE
    )
    spectra_infos <- data.frame(
        spectra_id = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
        score = c(79.8211975097656, 94.9317855834961, 95.1391906738281,
                  79.6432037353516, 71.3979721069336, 71.3979721069336,
                  89.4345550537109, 88.4888916015625, 82.740364074707,
                  99.5300903320312),
        deviation_mz = c(0.0003662109375, 0.000457763671875,
                         0.0008544921875, 0.000701904296875,
                         0.0010986328125, 0.001251220703125,
                         0.00140380859375, 0.0017852783203125,
                         -0.001068115234375, -0.000111897788883653),
        npeak = c(1, 2, 2, 1, 1, 1, 2, 2, 1, 3),
        basepeak_int = c(88824.635233072, 6214416.44108707,
                         6201250.27168528, 288290.748778874,
                         4945601.93026269, 5689144.27927454,
                         1448292.29379181, 1662831.19267642,
                         8927664.85468527, 4593482.66518999),
        sum_int = c(88824.635233072, 7385056.39979801, 7388017.8361341,
                    288290.748778874, 4945601.93026269, 5689144.27927454,
                    1849363.52087931, 2106914.27998355, 8927664.85468527,
                    5580653.54818653),
        sample = c("220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered"),
        rt = c(286.278, 286.81, 286.807, 286.807, 197.973, 205.173, 197.444,
               205.173, 178.504, 178.318)
    )
    spectras <- data.frame(
        spectra_id = c(1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5,
                       5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 10, 10,
                       10),
        feature_id = c(17, NA, NA, NA, 5, 4, NA, NA, 20, 19, NA, NA, 18, NA, NA,
                       NA, 1, NA, NA, NA, 14, NA, NA, NA, 2, 3, NA, NA, 15, 13,
                       NA, NA, 25, NA, NA, 31, 30, 29),
        mz = c(408.251325886321, NA, NA, NA, 426.261913381751, 427.265348519813,
               NA, NA, 426.262333104945, 427.265704881008, NA, NA,
               448.244170162955, NA, NA, NA, 464.447304014051, NA, NA, NA,
               464.447454557257, NA, NA, NA, 504.440032161331, 505.443534603,
               NA, NA, 504.44048100644, 505.44383474773, NA, NA,
               269.247528218739, NA, NA, 269.248411023224, 270.251620537443,
               271.255056943515),
        int = c(88824.635233072, NA, NA, NA, 6214416.44108707, 1170639.95871094,
                NA, NA, 6201250.27168528, 1186767.56444882, NA, NA,
                288290.748778874, NA, NA, NA, 4945601.93026269, NA, NA, NA,
                5689144.27927454, NA, NA, NA, 1448292.29379181,
                401071.227087501, NA, NA, 1662831.19267642, 444083.087307128,
                NA, NA, 8927664.85468527, NA, NA, 4593482.66518999,
                899482.748384234, 87688.1346123047),
        abd = c(100, NA, NA, NA, 100, 18.8374881182917, NA, NA, 100,
                19.1375531135642, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA, 100,
                NA, NA, NA, 100, 27.6926991054717, NA, NA, 100,
                26.7064443620612, NA, NA, 100, NA, NA, 100, 19.5817164000777,
                1.90896844515855),
        ion_id_theo = c(5, 5, 5, 5, 7, 7, 7, 7, 7, 7, 7, 7, 6, 6, 6, 6, 9, 9, 9,
                        9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 1, 1, 1,
                        1, 1, 1),
        mz_theo = c(408.25095, 409.25427, 410.25672, 411.25935, 426.26152,
                    427.26484, 428.26719, 429.26984, 426.26152, 427.26484,
                    428.26719, 429.26984, 448.24346, 449.24678, 450.24914,
                    451.25178, 464.44621, 465.44955, 466.45272, 467.45576,
                    464.44621, 465.44955, 466.45272, 467.45576, 504.43872,
                    505.44206, 506.44516, 507.44809, 504.43872, 505.44206,
                    506.44516, 507.44809, 269.2486, 270.25202, 271.25481,
                    269.2486, 270.25202, 271.25481),
        abd_theo = c(100, 21.65, 3.25, 0.38, 100, 21.7, 3.46, 0.42, 100, 21.7,
                     3.46, 0.42, 100, 21.69, 3.45, 0.42, 100, 33.55, 5.86, 0.65,
                     100, 33.55, 5.86, 0.65, 100, 33.67, 6.07, 0.72, 100, 33.67,
                     6.07, 0.72, 100, 18.84, 2.02, 100, 18.84, 2.02),
        iso_theo = c("M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M",
                     "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1",
                     "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2",
                     "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M",
                     "M+1", "M+2")
    )
    peak_groups <- data.frame(
        group_id = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
                     16, 17, 18),
        polarity = c("positive", "positive", "positive", "positive",
                     "positive", "positive", "positive", "positive",
                     "positive", "positive", "positive", "positive",
                     "negative", "negative", "negative", "negative",
                     "negative", "negative"),
        mzmed = c(408.251325886321, 426.262123243348, 427.265526700411,
                  428.267904280982, 428.268229167555, 429.27060132947,
                  429.270256788594, 429.270493526998, 448.244170162955,
                  464.447379285654, 504.440256583886, 505.443684675365,
                  269.247969620981, 269.248194873815, 269.248075605062,
                  270.251251784179, 270.251620537443, 271.255056943515),
        mzmin = c(408.251325886321, 426.261913381751, 427.265348519813,
                  428.267835743959, 428.267896400125, 429.270341280206,
                  429.270175958258, 429.270493526998, 448.244170162955,
                  464.447304014051, 504.440032161331, 505.443534603,
                  269.247528218739, 269.248194873815, 269.248075605062,
                  270.25119624422, 270.251620537443, 271.255056943515),
        mzmax = c(408.251325886321, 426.262333104945, 427.265704881008,
                  428.268466489791, 428.268561934985, 429.270861378734,
                  429.270782294993, 429.270493526998, 448.244170162955,
                  464.447454557257, 504.44048100644, 505.44383474773,
                  269.248411023224, 269.248194873815, 269.248075605062,
                  270.251307324138, 270.251620537443, 271.255056943515),
        rtmed = c(286.278, 286.8085, 286.8085, 279.407, 259.3105, 259.8395,
                  301.616, 279.407, 286.807, 201.573, 201.3085, 201.044,
                  178.411, 207.703, 146.11, 146.797, 178.318, 178.318),
        rtmin = c(286.278, 286.807, 286.807, 278.875, 258.253, 258.253,
                  291.569, 279.407, 286.807, 197.973, 197.444, 197.444,
                  178.318, 207.703, 146.11, 146.538, 178.318, 178.318),
        rtmax = c(286.278, 286.81, 286.81, 291.569, 260.368, 261.426,
                  306.914, 279.407, 286.807, 205.173, 205.173, 204.644,
                  178.504, 207.703, 146.11, 147.056, 178.318, 178.318),
        npeaks = c(1, 2, 2, 3, 2, 2, 3, 1, 1, 2, 2, 2, 2, 1, 1, 2, 1, 1),
        `220221CCM_global__01_ssleu_filtered` = c(NA, 5, 4, 6, 7, 10, 12,
                                                  9, NA, 1, 2, 3, 25, 26,
                                                  NA, 24, NA, NA),
        `220221CCM_global__02_ssleu_filtered` = c(17, 20, 19, 21, 22, 16,
                                                  23, NA, 18, 14, 15, 13,
                                                  31, NA, 28, 27, 30, 29),
        check.names = FALSE
    )
    peaks <- data.frame(
        feature_id = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
                       16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28,
                       29, 30, 31),
        mz = c(464.447304014051, 504.440032161331, 505.443534603,
               427.265348519813, 426.261913381751, 428.267835743959,
               428.267896400125, 428.267904280982, 429.270493526998,
               429.270341280206, 429.270256788594, 429.270175958258,
               505.44383474773, 464.447454557257, 504.44048100644,
               429.270861378734, 408.251325886321, 448.244170162955,
               427.265704881008, 426.262333104945, 428.268466489791,
               428.268561934985, 429.270782294993, 270.25119624422,
               269.247528218739, 269.248194873815, 270.251307324138,
               269.248075605062, 271.255056943515, 270.251620537443,
               269.248411023224),
        mzmin = c(464.447021484375, 504.439697265625, 505.443084716797,
                  427.264587402344, 426.261444091797, 428.267547607422,
                  428.267425537109, 428.267456054688, 429.270263671875,
                  429.269653320312, 429.269836425781, 429.269622802734,
                  505.440704345703, 464.446746826172, 504.439544677734,
                  429.270660400391, 408.251037597656, 448.242279052734,
                  427.265258789062, 426.262023925781, 428.268035888672,
                  428.267822265625, 429.270416259766, 270.250793457031,
                  269.247406005859, 269.24755859375, 270.250823974609,
                  269.247589111328, 271.254425048828, 270.251403808594,
                  269.247833251953),
        mzmax = c(464.447662353516, 504.440490722656, 505.443664550781,
                  427.266052246094, 426.262420654297, 428.268310546875,
                  428.268615722656, 428.268249511719, 429.270660400391,
                  429.270904541016, 429.270751953125, 429.270874023438,
                  505.444122314453, 464.447967529297, 504.441101074219,
                  429.271148681641, 408.25146484375, 448.245422363281,
                  427.266052246094, 426.262786865234, 428.269195556641,
                  428.269287109375, 429.271636962891, 270.251953125,
                  269.247985839844, 269.249572753906, 270.25244140625,
                  269.248596191406, 271.256134033203, 270.251831054688,
                  269.248565673828),
        rt = c(197.973, 197.444, 197.444, 286.81, 286.81, 279.407, 260.368,
               291.569, 279.407, 258.253, 291.569, 301.616, 204.644,
               205.173, 205.173, 261.426, 286.278, 286.807, 286.807,
               286.807, 278.875, 258.253, 306.914, 147.056, 178.504,
               207.703, 146.538, 146.11, 178.318, 178.318, 178.318),
        rtmin = c(196.386, 194.271, 196.386, 284.695, 284.695, 275.706,
                  232.343, 287.339, 275.706, 232.343, 287.339, 298.443,
                  203.577, 203.038, 178.178, 258.253, 284.692, 282.048,
                  283.105, 284.692, 266.184, 232.343, 301.084, 144.809,
                  175.697, 203.298, 144.81, 144.81, 175.036, 175.036,
                  175.036),
        rtmax = c(200.617, 199.03, 199.03, 291.04, 292.098, 287.339,
                  261.426, 295.799, 286.81, 265.656, 296.328, 305.847,
                  207.757, 206.729, 215.038, 264.069, 287.864, 292.095,
                  292.095, 292.095, 292.095, 265.656, 309.559, 149.306,
                  180.384, 212.035, 150.968, 150.968, 179.727, 181.586,
                  181.586),
        int = c(4945601.93026269, 1448292.29379181, 401071.227087501,
                1170639.95871094, 6214416.44108707, 10859267.7547045,
                15396334.0742375, 3559573.81687499, 2574017.18247619,
                4567668.49476563, 847985.874378674, 392347.130863636,
                444083.087307128, 5689144.27927454, 1662831.19267642,
                801559.236409095, 88824.635233072, 288290.748778874,
                1186767.56444882, 6201250.27168528, 20076653.1797449,
                18139587.026625, 323001.699462891, 15852.5738923645,
                8927664.85468527, 18758.2195488281, 18160.7346019531,
                136136.373335937, 87688.1346123047, 899482.748384234,
                4593482.66518999),
        intb = c(4945464.15722767, 1448264.72345856, 401069.111887501,
                 1170634.14246094, 6212404.90921921, 10279271.7340996,
                 14009363.2233988, 3181331.80055223, 2490170.67943366,
                 4327555.39189945, 790817.501274091, 248786.599772727,
                 444001.578713656, 5689141.10698883, 1662613.35060178,
                 801553.420409095, 88821.9918997387, 287904.836179229,
                 1185632.54587715, 6201242.86868528, 18364665.4121469,
                 15982556.4399262, 209052.408698731, 13737.5420380623,
                 8654644.93987011, 12054.5931199951, 15262.9337143676,
                 118521.494192171, 75981.4533509554, 886826.38870081,
                 4540712.99687556),
        maxo = c(4130684, 1395886, 434808.75, 676902.5, 3501824, 1096165,
                 592012.5, 533287, 266683.75, 168154.5, 123908.25,
                 84350.125, 524308, 5734716, 1723138, 150635.375,
                 70041.5625, 186253.875, 673140, 3489368, 1078367, 657937,
                 68280.5, 8709.96875, 6265286.5, 2761.9111328125,
                 8407.2734375, 71703.6875, 53069.5625, 734161, 3772552),
        sn = c(8329, 22672, 434808, 676902, 3587, 10, 7, 4, 12, 7, 5, 1,
               4386, 5734715, 14423, 145000, 70041, 675, 1134, 3489367, 9,
               5, 1, 13, 15, 3, 11, 11, 3, 109, 298),
        egauss = as.numeric(c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                              NA, NA, NA, NA, NA, NA, NA, NA, NA)),
        mu = as.numeric(c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                          NA, NA, NA, NA, NA, NA, NA, NA, NA)),
        sigma = as.numeric(c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                             NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                             NA, NA, NA, NA, NA, NA, NA, NA, NA)),
        h = as.numeric(c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                         NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
                         NA, NA, NA, NA, NA, NA, NA, NA, NA)),
        f = c(1, 2, 3, 4, 6, 7, 7, 7, 8, 8, 8, 11, 1, 2, 3, 4, 5, 6, 7, 8,
              9, 9, 14, 1, 2, 3, 1, 2, 6, 7, 8),
        dppm = c(1, 2, 1, 2, 1, 2, 1, 0, 1, 1, 1, 2, 7, 2, 3, 1, 1, 2, 1, 1,
                 0, 1, 3, 3, 2, 4, 6, 3, 6, 2, 1),
        scale = c(3, 3, 3, 5, 5, 3, 15, 5, 3, 13, 5, 3, 3, 13, 19, 3, 3, 5,
                  5, 5, 11, 13, 5, 2, 2, 2, 3, 3, 3, 3, 3),
        scpos = c(58, 57, 57, 187, 187, 173, 137, 196, 173, 133, 196, 215,
                  57, 58, 58, 136, 183, 184, 184, 184, 169, 130, 222, 5, 44,
                  75, 5, 4, 52, 52, 52),
        scmin = c(55, 54, 54, 182, 182, 170, 122, 191, 170, 120, 191, 212,
                  54, 45, 39, 133, 180, 179, 179, 179, 158, 117, 217, 3, 42,
                  73, 2, 1, 49, 49, 49),
        scmax = c(61, 60, 60, 192, 192, 176, 152, 201, 176, 146, 201, 218,
                  60, 71, 77, 139, 186, 189, 189, 189, 180, 143, 227, 7, 46,
                  77, 8, 7, 55, 55, 55),
        lmin = c(55, 52, 55, 87, 87, 134, 87, 156, 134, 87, 156, 85, 55, 54,
                 20, 101, 87, 82, 84, 87, 116, 87, 79, 1, 40, 66, 1, 1, 47,
                 47, 47),
        lmax = c(63, 60, 60, 99, 101, 156, 107, 172, 155, 115, 173, 96, 63,
                 61, 77, 112, 93, 101, 101, 101, 165, 115, 95, 9, 48, 74,
                 11, 11, 55, 58, 58),
        sample = c("220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered"),
        polarity = c("positive", "positive", "positive", "positive",
                     "positive", "positive", "positive", "positive",
                     "positive", "positive", "positive", "positive",
                     "positive", "positive", "positive", "positive",
                     "positive", "positive", "positive", "positive",
                     "positive", "positive", "positive",
                     "negative", "negative", "negative", "negative",
                     "negative", "negative", "negative", "negative")
    )

    # initialize parameters
    raw_files <- c(
        system.file(
            "testdata",
            "220221CCM_global_POS_02_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        system.file(
            "testdata",
            "220221CCM_global_POS_01_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        system.file(
            "testdata",
            "220221CCM_global_NEG_02_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        system.file(
            "testdata",
            "220221CCM_global_NEG_01_ssleu_filtered.mzML",
            package = "workflow.lipido"
        )
    )
    sqlite_path <- tempfile(fileext = ".sqlite")
    converter <- tools::file_path_as_absolute(
        "~/GitHub/workflow.lipido/pwiz/msconvert.exe"
    )
    cwt_params <- xcms::CentWaveParam(
        ppm = 30,
        peakwidth = c(4, 39),
        snthresh = 1,
        prefilter = c(2, 815),
        mzCenterFun = "wMean",
        integrate = 1,
        mzdiff = .041,
        fitgauss = FALSE,
        noise = 0,
        verboseColumns = TRUE,
        firstBaselineCheck = FALSE
    )
    obw_params <- xcms::ObiwarpParam(
        binSize = .1,
        centerSample = integer(),
        response = 1L,
        distFun = "cor_opt",
        gapInit = .3,
        gapExtend = 2.4,
        factorDiag = 2,
        factorGap = 1,
        localAlignment = FALSE,
        initPenalty = 0
    )
    pd_params <- xcms::PeakDensityParam(
        sampleGroups = seq(2),
        bw = 5,
        minFraction = 10**-9,
        minSamples = 1,
        binSize = 0.01,
        maxFeatures = 500
    )
    ann_params <- AnnotationParam(
        da_tol = .015,
        rt_tol = 10,
        abd_tol = 25,
        adduct_names = c(
            "[M+Na]+",
            "[M+NH4]+",
            "[M+H-H2O]+",
            "[M+H]+",
            "[M-H]-"
        ),
        database = "test",
        instrument = "QTOF_XevoG2-S_R25000@200",
        cpd_classes = c("LPC", "Cer", "FA")
    )
    ann_params_error1 <- ann_params_error2 <- ann_params
    ann_params_error1@cpd_classes <- "PS"
    ann_params_error2@da_tol <- .015

    # 1st test: no compound can be loaded
    testthat::expect_error(
        invisible(capture.output(ms_process(
            raw_files,
            sqlite_path,
            converter,
            cwt_params,
            obw_params,
            pd_params,
            ann_params_error1
        ))),
        "no chemical compounds can be loaded with the given parameters"
    )

    # 3rd test: no parallelization
    invisible(capture.output(ms_process(
        raw_files,
        sqlite_path,
        converter,
        cwt_params,
        obw_params,
        pd_params,
        ann_params,
        cores = 1
    )))
    db <- db_connect(sqlite_path)
    testthat::expect_equal(
        dbReadTable(db, "ann"),
        ann
    )
    testthat::expect_equal(
        dbReadTable(db, "spectra_infos"),
        spectra_infos
    )
    testthat::expect_equal(
        dbReadTable(db, "spectras"),
        spectras
    )
    testthat::expect_equal(
        dbReadTable(db, "peak_groups"),
        peak_groups
    )
    testthat::expect_equal(
        dbReadTable(db, "peaks"),
        peaks
    )
    RSQLite::dbDisconnect(db)

    # 4th test: parallelization
    capture.output(ms_process(
        raw_files,
        sqlite_path,
        converter,
        cwt_params,
        obw_params,
        pd_params,
        ann_params
    ))
    db <- db_connect(sqlite_path)
    testthat::expect_equal(
        dbReadTable(db, "ann"),
        ann
    )
    testthat::expect_equal(
        dbReadTable(db, "spectra_infos"),
        spectra_infos
    )
    testthat::expect_equal(
        dbReadTable(db, "spectras"),
        spectras
    )
    testthat::expect_equal(
        dbReadTable(db, "peak_groups"),
        peak_groups
    )
    testthat::expect_equal(
        dbReadTable(db, "peaks"),
        peaks
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("export annotations", {
    ann <- data.frame(
        group_id = c(1, 1, 2, 2, 9, 9, 10, 11, 13),
        class = c(rep("LPC", 6), rep("Cer", 2), "FA"),
        name = c("LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0", "LPC 11:0",
                 "LPC 11a:0", "Cer (d18:1/C12:0)", "Cer (d18:1/C12:0)",
                 "FA 17:0"),
        formula = c("C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C30H59N1O3", "C30H59N1O3", "C17H34O2"),
        adduct = c("[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+", "[M+Na]+",
                   "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", "[M-H]-"),
        ion_formula = c("C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                        "C19H41N1O7P1", "C19H40N1O7P1Na1", "C19H40N1O7P1Na1",
                        "C30H58N1O2", "C30H59N1O3Na1", "C17H33O2"),
        rtdiff = c(9.52199999999993, 4.72199999999998, 8.99149999999997,
                   4.19150000000002, 8.99299999999994, 4.19299999999998,
                   5.97300000000001, 5.70849999999999, 2.18899999999999),
        rt = c(286.278, 286.278, 286.8085, 286.8085, 286.807, 286.807, 201.573,
               201.3085, 178.411),
        rtmin = c(284.692, 284.692, 284.692, 284.692, 282.048, 282.048, 196.386,
                  178.178, 175.036),
        rtmax = c(287.864, 287.864, 292.098, 292.098, 292.095, 292.095, 206.729,
                  215.038, 181.586),
        nsamples = c(1, 1, 2, 2, 1, 1, 2, 2, 2),
        best_score = c(79.8211975097656, 79.8211975097656, 95.1391906738281,
                       95.1391906738281, 79.6432037353516, 79.6432037353516,
                       71.3979721069336, 89.4345550537109, 99.5300903320312),
        best_deviation_mz = c(0.0003662109375, 0.0003662109375, 0.0008544921875,
                              0.0008544921875, 0.000701904296875,
                              0.000701904296875, 0.0010986328125,
                              0.00140380859375, -0.000111897788883653),
        best_npeak = c(1, 1, 2, 2, 1, 1, 1, 2, 3),
        `220221CCM_global__01_ssleu_filtered` = c(NA, NA, 2, 2, NA, NA, 5, 7,
                                                  9),
        `220221CCM_global__02_ssleu_filtered` = c(1, 1, 3, 3, 4, 4, 6, 8, 10),
        check.names = FALSE
    )
    spectra_infos <- data.frame(
        spectra_id = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
        score = c(79.8211975097656, 94.9317855834961, 95.1391906738281,
                  79.6432037353516, 71.3979721069336, 71.3979721069336,
                  89.4345550537109, 88.4888916015625, 82.740364074707,
                  99.5300903320312),
        deviation_mz = c(0.0003662109375, 0.000457763671875,
                         0.0008544921875, 0.000701904296875,
                         0.0010986328125, 0.001251220703125,
                         0.00140380859375, 0.0017852783203125,
                         -0.001068115234375, -0.000111897788883653),
        npeak = c(1, 2, 2, 1, 1, 1, 2, 2, 1, 3),
        basepeak_int = c(88824.635233072, 6214416.44108707,
                         6201250.27168528, 288290.748778874,
                         4945601.93026269, 5689144.27927454,
                         1448292.29379181, 1662831.19267642,
                         8927664.85468527, 4593482.66518999),
        sum_int = c(88824.635233072, 7385056.39979801, 7388017.8361341,
                    288290.748778874, 4945601.93026269, 5689144.27927454,
                    1849363.52087931, 2106914.27998355, 8927664.85468527,
                    5580653.54818653),
        sample = c("220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered",
                   "220221CCM_global__01_ssleu_filtered",
                   "220221CCM_global__02_ssleu_filtered"),
        rt = c(286.278, 286.81, 286.807, 286.807, 197.973, 205.173, 197.444,
               205.173, 178.504, 178.318)
    )

    excel_file <- tempfile(fileext = ".xlsx")
    sqlite_file <- system.file(
        "testdata",
        "220221CCM_global.sqlite",
        package = "workflow.lipido"
    )
    sqlite_file2 <- gsub("\\\\", "/", tempfile(fileext = ".sqlite"))
    invisible(file.copy(sqlite_file, sqlite_file2))
    ann <- split_conflicts(ann)

    # 1st : test with a wrong sqlite path
    testthat::expect_error(
        export_annotations(2, NULL),
        "sqlite file arg must be a filepath to a database file"
    )

    # 2nd : test with a missing excel file
    testthat::expect_error(
        export_annotations("test.sqlite", NULL),
        "the path in the sqlite file arg doesn't exist"
    )

    # 3rd : test with a wrong excel file
    testthat::expect_error(
        export_annotations(sqlite_file2, 2),
        "excel file arg must be a filepath to a database file"
    )

    # 4th : test with a missing direcory for the excel file
    testthat::expect_error(
        export_annotations(sqlite_file2, "a/a.xlsx"),
        "the directory path to the excel file arg doesn't exist"
    )

    # 5th : normal
    export_annotations(sqlite_file2, excel_file)
    ann_summarised <- summarise_ann(
        ann$no_conflicts,
        spectra_infos,
        nsamples = 2
    )
    ann_summarised$nSamples <- as.numeric(ann_summarised$nSamples)
    ann_summarised[, c("class", "Most intense ion")] <- lapply(
        ann_summarised[, c("class", "Most intense ion")], as.character)
    testthat::expect_equal(
        openxlsx::read.xlsx(excel_file, 1, sep.names = " "),
        ann_summarised
    )
    int_ann <- get_int_ann(ann$no_conflicts, spectra_infos, nsamples = 2)
    int_ann$class <- as.character(int_ann$class)
    testthat::expect_equal(
        openxlsx::read.xlsx(excel_file, 2, sep.names = " "),
        data.frame(int_ann, row.names = NULL, check.names = FALSE)
    )

    # 7th : with only positive annotations
    export_annotations(sqlite_file2, excel_file, polarity = "positive")
    testthat::expect_equal(
        openxlsx::read.xlsx(excel_file, 1, sep.names = " "),
        ann_summarised[grepl("\\+$", ann_summarised$Adducts), ]
    )
    testthat::expect_equal(
        openxlsx::read.xlsx(excel_file, 2, sep.names = " "),
        data.frame(
            int_ann[grepl("\\+$", int_ann$Adduct), ],
            row.names = NULL,
            check.names = FALSE
        )
    )

    # 7th : with only negative annotations
    export_annotations(sqlite_file2, excel_file, polarity = "negative")
    testthat::expect_equal(
        openxlsx::read.xlsx(excel_file, 1, sep.names = " "),
        data.frame(
            ann_summarised[grepl("\\-$", ann_summarised$Adducts), ],
            row.names = NULL,
            check.names = FALSE
        )
    )
    testthat::expect_equal(
        openxlsx::read.xlsx(excel_file, 2, sep.names = " "),
        data.frame(
            int_ann[grepl("\\-$", int_ann$Adduct), ],
            row.names = NULL,
            check.names = FALSE
        )
    )

    # 8th test : with all annotations in conflicts
    db <- db_connect(sqlite_file2)
    dbExecute(db, "delete from ann where group_id in (10, 11, 13)")
    testthat::expect_error(
        export_annotations(sqlite_file2, excel_file),
        "no annotations with 0 conflicts"
    )

    # 9th test : with no annotations
    dbExecute(db, "delete from ann")
    testthat::expect_error(
        export_annotations(sqlite_file2, excel_file),
        "no annotations in database"
    )
    RSQLite::dbDisconnect(db)
})
