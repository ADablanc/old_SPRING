testthat::test_that("group peaks", {
    pd_params <- xcms::PeakDensityParam(
        sampleGroups = seq(3),
        bw = 5,
        minFraction = 10**-9,
        minSamples = 1,
        binSize = 0.01,
        maxFeatures = 500
    )
    xset <- methods::new("xcmsSet")
    xset@phenoData <- data.frame(
        class = rep(runif(1), 3),
        row.names = c(
            "220221CCM_global_POS_01_ssleu_filtered",
            "220221CCM_global_POS_02_ssleu_filtered",
            "220221CCM_global_POS_03_ssleu_filtered")
    )
    peaks <- matrix(
        c(464.447304014051, 504.440032161331, 505.443534603, 427.265348519813,
          426.261913381751, 428.267835743959, 428.267896400125,
          428.267904280982, 429.270493526998, 429.270341280206,
          429.270256788594, 429.270175958258, 505.44383474773, 464.447454557257,
          504.44048100644, 429.270861378734, 408.251325886321, 448.244170162955,
          427.265704881008, 426.262333104945, 428.268466489791,
          428.268561934985, 429.270782294993, 464.447021484375,
          504.439697265625, 505.443084716797, 427.264587402344,
          426.261444091797, 428.267547607422, 428.267425537109,
          428.267456054688, 429.270263671875, 429.269653320312,
          429.269836425781, 429.269622802734, 505.440704345703,
          464.446746826172, 504.439544677734, 429.270660400391,
          408.251037597656, 448.242279052734, 427.265258789062,
          426.262023925781, 428.268035888672, 428.267822265625,
          429.270416259766, 464.447662353516, 504.440490722656,
          505.443664550781, 427.266052246094, 426.262420654297,
          428.268310546875, 428.268615722656, 428.268249511719,
          429.270660400391, 429.270904541016, 429.270751953125,
          429.270874023438, 505.444122314453, 464.447967529297,
          504.441101074219, 429.271148681641, 408.25146484375, 448.245422363281,
          427.266052246094, 426.262786865234, 428.269195556641,
          428.269287109375, 429.271636962891, 197.973, 197.444, 197.444, 286.81,
          286.81, 279.407, 260.368, 291.569, 279.407, 258.253, 291.569, 301.616,
          204.644, 205.173, 205.173, 261.426, 286.278, 286.807, 286.807,
          286.807, 278.875, 258.253, 306.914, 196.386, 194.271, 196.386,
          284.695, 284.695, 275.706, 232.343, 287.339, 275.706, 232.343,
          287.339, 298.443, 203.577, 203.038, 178.178, 258.253, 284.692,
          282.048, 283.105, 284.692, 266.184, 232.343, 301.084, 200.617, 199.03,
          199.03, 291.04, 292.098, 287.339, 261.426, 295.799, 286.81, 265.656,
          296.328, 305.847, 207.757, 206.729, 215.038, 264.069, 287.864,
          292.095, 292.095, 292.095, 292.095, 265.656, 309.559,
          4945601.93026269, 1448292.29379181, 401071.227087501,
          1170639.95871094, 6214416.44108707, 10859267.7547045,
          15396334.0742375, 3559573.81687499, 2574017.18247619,
          4567668.49476563, 847985.874378674, 392347.130863636,
          444083.087307128, 5689144.27927454, 1662831.19267642,
          801559.236409095, 88824.635233072, 288290.748778874, 1186767.56444882,
          6201250.27168528, 20076653.1797449, 18139587.026625, 323001.699462891,
          4945464.15722767, 1448264.72345856, 401069.111887501,
          1170634.14246094, 6212404.90921921, 10279271.7340996,
          14009363.2233988, 3181331.80055223, 2490170.67943366,
          4327555.39189945, 790817.501274091, 248786.599772727,
          444001.578713656, 5689141.10698883, 1662613.35060178,
          801553.420409095, 88821.9918997387, 287904.836179229,
          1185632.54587715, 6201242.86868528, 18364665.4121469,
          15982556.4399262, 209052.408698731, 4130684, 1395886, 434808.75,
          676902.5, 3501824, 1096165, 592012.5, 533287, 266683.75, 168154.5,
          123908.25, 84350.125, 524308, 5734716, 1723138, 150635.375,
          70041.5625, 186253.875, 673140, 3489368, 1078367, 657937, 68280.5,
          8329, 22672, 434808, 676902, 3587, 10, 7, 4, 12, 7, 5, 1, 4386,
          5734715, 14423, 145000, 70041, 675, 1134, 3489367, 9, 5, 1, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, 1, 2, 3, 4, 6, 7, 7, 7, 8, 8, 8, 11, 1, 2, 3, 4,
          5, 6, 7, 8, 9, 9, 14, 1, 2, 1, 2, 1, 2, 1, 0, 1, 1, 1, 2, 7, 2, 3, 1,
          1, 2, 1, 1, 0, 1, 3, 3, 3, 3, 5, 5, 3, 15, 5, 3, 13, 5, 3, 3, 13, 19,
          3, 3, 5, 5, 5, 11, 13, 5, 58, 57, 57, 187, 187, 173, 137, 196, 173,
          133, 196, 215, 57, 58, 58, 136, 183, 184, 184, 184, 169, 130, 222, 55,
          54, 54, 182, 182, 170, 122, 191, 170, 120, 191, 212, 54, 45, 39, 133,
          180, 179, 179, 179, 158, 117, 217, 61, 60, 60, 192, 192, 176, 152,
          201, 176, 146, 201, 218, 60, 71, 77, 139, 186, 189, 189, 189, 180,
          143, 227, 55, 52, 55, 87, 87, 134, 87, 156, 134, 87, 156, 85, 55, 54,
          20, 101, 87, 82, 84, 87, 116, 87, 79, 63, 60, 60, 99, 101, 156, 107,
          172, 155, 115, 173, 96, 63, 61, 77, 112, 93, 101, 101, 101, 165, 115,
          95, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
          2),
        nrow = 23, ncol = 23, dimnames = list(
            c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                   "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                   "dppm", "scale", "scpos", "scmin", "scmax", "lmin", "lmax",
                   "sample")
        )
    )

    # 1st test: with no peaks
    xset <- group_peaks(xset, pd_params)
    testthat::expect_equal(
        xset@groups,
        matrix(, nrow = 0, ncol = 10, dimnames = list(
            c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                   "npeaks", "1", "2", "3"))
        )
    )

    # 2nd test: only one sample has peaks
    xset@peaks <- peaks[peaks[, "sample"] == 1, ]
    xset <- group_peaks(xset, pd_params)
    testthat::expect_equal(
        xset@groups,
        matrix(
            c(426.261913381751, 427.265348519813, 428.267835743959,
              428.267904280982, 428.267896400125, 429.270216373426,
              429.270493526998, 429.270341280206, 464.447304014051,
              504.440032161331, 505.443534603, 426.261913381751,
              427.265348519813, 428.267835743959, 428.267904280982,
              428.267896400125, 429.270175958258, 429.270493526998,
              429.270341280206, 464.447304014051, 504.440032161331,
              505.443534603, 426.261913381751, 427.265348519813,
              428.267835743959, 428.267904280982, 428.267896400125,
              429.270256788594, 429.270493526998, 429.270341280206,
              464.447304014051, 504.440032161331, 505.443534603, 286.81, 286.81,
              279.407, 291.569, 260.368, 296.5925, 279.407, 258.253, 197.973,
              197.444, 197.444, 286.81, 286.81, 279.407, 291.569, 260.368,
              291.569, 279.407, 258.253, 197.973, 197.444, 197.444, 286.81,
              286.81, 279.407, 291.569, 260.368, 301.616, 279.407, 258.253,
              197.973, 197.444, 197.444, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1,
              1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
              0, 0, 0, 0, 0, 0, 0, 0, 0),
            nrow = 11, ncol = 10, dimnames = list(
                c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                       "npeaks", "1", "2", "3")
            )
        )
    )

    # 3rd test: normal
    xset@peaks <- peaks
    xset <- group_peaks(xset, pd_params)
    testthat::expect_equal(
        xset@groups,
        matrix(
            c(408.251325886321, 426.262123243348, 427.265526700411,
              428.267904280982, 428.268229167555, 429.27060132947,
              429.270256788594, 429.270493526998, 448.244170162955,
              464.447379285654, 504.440256583885, 505.443684675365,
              408.251325886321, 426.261913381751, 427.265348519813,
              428.267835743959, 428.267896400125, 429.270341280206,
              429.270175958258, 429.270493526998, 448.244170162955,
              464.447304014051, 504.440032161331, 505.443534603,
              408.251325886321, 426.262333104945, 427.265704881008,
              428.268466489791, 428.268561934985, 429.270861378734,
              429.270782294993, 429.270493526998, 448.244170162955,
              464.447454557257, 504.44048100644, 505.44383474773, 286.278,
              286.8085, 286.8085, 279.407, 259.3105, 259.8395, 301.616, 279.407,
              286.807, 201.573, 201.3085, 201.044, 286.278, 286.807, 286.807,
              278.875, 258.253, 258.253, 291.569, 279.407, 286.807, 197.973,
              197.444, 197.444, 286.278, 286.81, 286.81, 291.569, 260.368,
              261.426, 306.914, 279.407, 286.807, 205.173, 205.173, 204.644, 1,
              2, 2, 3, 2, 2, 3, 1, 1, 2, 2, 2, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1,
              1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
              0, 0, 0),
            nrow = 12, ncol = 10, dimnames = list(
                c(), c("mzmed", "mzmin", "mzmax", "rtmed", "rtmin", "rtmax",
                       "npeaks", "1", "2", "3")
            )
        )
    )
})
