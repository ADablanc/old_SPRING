testthat::test_that("peak picking", {
    empty_peaklist <- matrix(, nrow = 0, ncol = 23, dimnames = list(
        c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
               "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
               "dppm", "scale", "scpos", "scmin", "scmax", "lmin", "lmax",
               "sample")
    ))
    cwt_params <- xcms::CentWaveParam(
        ppm = 30,
        peakwidth = c(4, 39),
        snthresh = 1,
        prefilter = c(2, 815),
        mzCenterFun = "wMean",
        integrate = 1,
        mzdiff = .041,
        fitgauss = FALSE,
        noise = 0,
        verboseColumns = TRUE,
        firstBaselineCheck = FALSE
    )

    # 1st test with no file
    testthat::expect_identical(
        find_chrompeaks(NULL, cwt_params, "small")@peaks,
        empty_peaklist
    )

    # 2nd test with no peaks
    ms_file <- xcms::xcmsRaw(
        system.file("testdata", "small.mzXML", package = "workflow.lipido"),
        profstep = 0
    )
    testthat::expect_identical(
        find_chrompeaks(ms_file, cwt_params, "small")@peaks,
        empty_peaklist
    )

    # 3rd test with peaks
    ms_file <- xcms::xcmsRaw(
        system.file(
            "testdata",
            "220221CCM_global_POS_01_ssleu_filtered.mzML",
            package = "workflow.lipido"
        ),
        profstep = 0
    )
    testthat::expect_equal(
        find_chrompeaks(
            ms_file,
            cwt_params,
            "220221CCM_global_POS_01_ssleu_filtered"
        )@peaks,
        matrix(
            c(464.447304014051, 504.440032161331, 505.443534603,
              427.265397484755, 448.243644005027, 426.261908233279,
              428.267772595199, 428.267855601901, 429.270423563444,
              429.270339913969, 429.269607476748, 428.2675574767,
              428.267840674347, 464.447021484375, 504.439697265625,
              505.443084716797, 427.264739990234, 448.243011474609,
              426.261444091797, 428.267364501953, 428.267425537109,
              429.269836425781, 429.269653320312, 429.269256591797,
              428.267242431641, 428.267364501953, 464.447662353516,
              504.440490722656, 505.443664550781, 427.266052246094,
              448.245391845703, 426.262420654297, 428.268310546875,
              428.268615722656, 429.271362304688, 429.270904541016,
              429.269958496094, 428.268035888672, 428.2685546875, 197.973,
              197.444, 197.444, 286.81, 286.81, 286.81, 279.407, 258.782,
              279.407, 258.782, 296.857, 297.915, 308.494, 196.386, 193.743,
              196.386, 284.695, 285.224, 284.695, 265.656, 250.85, 265.656,
              250.85, 295.271, 293.684, 304.789, 200.617, 199.03, 199.03,
              291.04, 291.04, 291.04, 293.156, 264.598, 294.742, 264.598,
              307.966, 303.202, 310.081, 4945601.93026269, 1287181.56877954,
              401071.227087501, 1170639.95871094, 260064.992761365,
              6139220.0505469, 21634957.3317308, 7556081.77126924,
              5360632.29847273, 1854836.50349039, 450077.636764323,
              2235868.3566111, 753309.518850004, 4945487.79875439,
              1287161.27013964, 401069.111887501, 1170297.42409805,
              251531.954604928, 6137759.54643873, 20459048.501706,
              6979304.74283053, 5183447.80457555, 1771087.19378474,
              359253.245444391, 1369338.9068287, 436642.365357695, 4130684,
              1395886, 434808.75, 676902.5, 183977.625, 3501824, 1096165,
              647081.5, 266683.75, 158095.875, 90547.25, 387221, 271995.5, 9148,
              24876, 434808, 2254, 2, 3876, 10, 6, 13, 8, 2, 1, 1, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, 1, 2, 3, 4, 5, 6, 7, 7, 8, 8, 9, 10, 13, 1, 2, 1, 2, 4, 1, 1,
              1, 0, 0, 1, 1, 3, 4, 4, 4, 4, 6, 4, 10, 14, 10, 14, 12, 4, 4, 68,
              67, 67, 236, 236, 236, 222, 183, 222, 183, 255, 257, 277, 64, 63,
              63, 232, 230, 232, 212, 169, 212, 169, 243, 253, 273, 72, 71, 71,
              240, 242, 240, 232, 197, 232, 197, 267, 261, 281, 65, 60, 65, 108,
              104, 108, 136, 108, 136, 108, 108, 104, 103, 73, 70, 70, 120, 115,
              120, 188, 134, 191, 134, 132, 122, 113, 1, 1, 1, 1, 1, 1, 1, 1, 1,
              1, 1, 1, 1),
            nrow = 13, ncol = 23, dimnames = list(
                c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                       "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                       "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                       "lmax", "sample")
            )
        )
    )
})
